<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Factures de Loyer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #6c757d;
            --danger-color: #f44336;
            --success-color: #25D366;
            --warning-color: #ff9800;
            --light-bg: #f8f9fa;
            --dark-text: #333;
            --medium-text: #555;
            --light-text: #777;
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 8px;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-text);
            padding: 10px;
        }
        
        .login-container {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-container h1 {
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 24px;
        }
        
        .login-form {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--medium-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .login-button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .login-button:hover {
            background-color: var(--primary-dark);
        }
        
        .error-message {
            color: var(--danger-color);
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(244, 67, 54, 0.1);
            border-radius: var(--radius);
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .app-container {
            display: none;
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin: 15px;
        }
        
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .app-header h1 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .logout-button, .backup-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .logout-button:hover, .backup-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .tabs {
            display: flex;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab {
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            min-width: 120px;
            justify-content: center;
        }
        
        .tab:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 200px;
        }
        
        .auto-total-section {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
        }
        
        .auto-total-section h3 {
            margin-top: 0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
        }
        
        .auto-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auto-total-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 16px;
        }
        
        .auto-total-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .item-row {
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            background-color: var(--light-bg);
            position: relative;
        }
        
        .remove-item {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        button {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        
        button.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        button.primary:hover {
            background-color: var(--primary-dark);
        }
        
        button.secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        button.whatsapp {
            background-color: var(--success-color);
            color: white;
        }
        
        button.whatsapp:hover {
            background-color: #128C7E;
        }
        
        button.reset {
            background-color: var(--warning-color);
            color: white;
        }
        
        button.reset:hover {
            background-color: #e68900;
        }
        
        button.export {
            background-color: #6f42c1;
            color: white;
        }
        
        button.export:hover {
            background-color: #5e35b1;
        }
        
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .invoice-preview {
            margin-top: 25px;
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
        }
        
        .invoice-preview h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
        }
        
        .invoice-container {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: var(--radius);
            background-color: white;
            margin-bottom: 15px;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .company-info h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        
        .invoice-title {
            text-align: center;
        }
        
        .invoice-title h1 {
            margin: 0;
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .invoice-code {
            margin-top: 5px;
            font-weight: 600;
            color: var(--medium-text);
            font-size: 14px;
        }
        
        .invoice-details p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .client-info {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .client-info h4 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .invoice-table th, .invoice-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .invoice-table th {
            background-color: var(--light-bg);
            font-weight: 600;
        }
        
        .total-row {
            font-weight: 600;
            background-color: var(--light-bg);
        }
        
        .invoice-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .signature-section {
            text-align: center;
        }
        
        .signature-line {
            border-top: 1px solid var(--border-color);
            width: 150px;
            margin-top: 30px;
        }
        
        .security-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        .payment-code {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 1px;
            margin: 8px 0;
        }
        
        .pdf-format-selector {
            margin-bottom: 15px;
        }
        
        .pdf-format-selector label {
            margin-right: 12px;
            cursor: pointer;
        }
        
        .tenants-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .tenant-card {
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 15px;
            background-color: white;
        }
        
        .tenant-card h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .tenant-card p {
            margin: 6px 0;
            font-size: 14px;
        }
        
        .tenant-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .tenant-actions button {
            flex: 1;
            min-width: 80px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .history-table th, .history-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-table th {
            background-color: var(--light-bg);
            font-weight: 600;
        }
        
        .chart-container {
            margin-top: 25px;
            background-color: white;
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            height: 300px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--light-bg);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
        }
        
        .stat-card h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .stat-card p {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }
        
        .verify-section {
            text-align: center;
            padding: 30px 15px;
        }
        
        .qr-scanner {
            max-width: 350px;
            margin: 0 auto 25px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
        }
        
        .verify-result {
            margin-top: 15px;
            padding: 12px;
            border-radius: var(--radius);
            display: none;
        }
        
        .verify-result.valid {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .verify-result.invalid {
            background-color: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        /* Responsive Design */
        /* Tablettes (écrans moyens) */
        @media (max-width: 1024px) {
            .app-container {
                margin: 10px;
            }
            
            .chart-container {
                height: 280px;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tablettes petites et grands mobiles */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .login-container {
                padding: 25px;
            }
            
            .app-container {
                margin: 8px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 100px;
                justify-content: center;
                padding: 10px 12px;
            }
            
            .invoice-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .invoice-footer {
                flex-direction: column;
                gap: 25px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .actions button {
                width: 100%;
                justify-content: center;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .tenants-container {
                grid-template-columns: 1fr;
            }
            
            .invoice-table {
                font-size: 12px;
            }
            
            .invoice-table th, .invoice-table td {
                padding: 6px 8px;
            }
            
            .auto-total-actions {
                flex-direction: column;
            }
            
            .tenant-actions {
                flex-direction: column;
            }
            
            .tenant-actions button {
                width: 100%;
            }
        }

        /* Mobiles (écrans petits) */
        @media (max-width: 480px) {
            .login-container {
                padding: 20px;
            }
            
            .login-container h1 {
                font-size: 22px;
            }
            
            .app-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .app-header h1 {
                font-size: 18px;
            }
            
            .tab {
                min-width: 90px;
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .tab-content {
                padding: 12px;
            }
            
            .form-section h2 {
                font-size: 18px;
            }
            
            .invoice-container {
                padding: 15px;
            }
            
            .invoice-title h1 {
                font-size: 18px;
            }
            
            .invoice-table {
                font-size: 11px;
            }
            
            .invoice-table th, .invoice-table td {
                padding: 5px 6px;
            }
            
            .signature-line {
                width: 120px;
            }
            
            .payment-code {
                font-size: 14px;
            }
            
            .chart-container {
                height: 220px;
                padding: 12px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card h4 {
                font-size: 13px;
            }
            
            .stat-card p {
                font-size: 18px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 13px;
            }
        }

        /* Très petits écrans */
        @media (max-width: 320px) {
            .login-container {
                padding: 15px;
            }
            
            .app-container {
                margin: 5px;
            }
            
            .tab {
                min-width: 80px;
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .invoice-container {
                padding: 10px;
            }
            
            .invoice-table {
                font-size: 10px;
            }
            
            .chart-container {
                height: 200px;
                padding: 10px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-card p {
                font-size: 16px;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-container, .invoice-container * {
                visibility: visible;
            }
            .invoice-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                box-shadow: none;
                margin: 0;
                padding: 15px;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div class="login-container" id="loginContainer">
        <h1><i class="fas fa-file-invoice-dollar"></i> Connexion</h1>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username"><i class="fas fa-user"></i> Identifiant</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Mot de passe</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="login-button"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
            <div class="error-message" id="errorMessage"><i class="fas fa-exclamation-triangle"></i> Identifiant ou mot de passe incorrect</div>
        </form>
    </div>

    <!-- Application principale -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <h1><i class="fas fa-home"></i> Gestionnaire de Factures de Loyer</h1>
            <div class="header-buttons">
                <button class="logout-button" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
                <button class="backup-button" id="backupButton" title="Sauvegarde automatique activée"><i class="fas fa-shield-alt"></i> Sauvegarde</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="create"><i class="fas fa-plus-circle"></i> Créer une Facture</div>
            <div class="tab" data-tab="tenants"><i class="fas fa-users"></i> Locataires</div>
            <div class="tab" data-tab="history"><i class="fas fa-history"></i> Historique</div>
            <div class="tab" data-tab="sales"><i class="fas fa-chart-bar"></i> Analyse</div>
            <div class="tab" data-tab="verify"><i class="fas fa-qrcode"></i> Vérifier</div>
        </div>
        
        <!-- Onglet Création de facture -->
        <div id="create-tab" class="tab-content active">
            <div class="form-section">
                <h2><i class="fas fa-file-alt"></i> Informations de la Facture de Loyer</h2>
                <form id="invoiceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date"><i class="fas fa-calendar-alt"></i> Date de la facture</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="companyName"><i class="fas fa-building"></i> Nom du propriétaire</label>
                            <input type="text" id="companyName" value="JEANSKODOC" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyAddress"><i class="fas fa-map-marker-alt"></i> Adresse du propriétaire</label>
                            <textarea id="companyAddress" rows="3" required>Kara-Togo</textarea>
                        </div>
                        <div class="form-group">
                            <label for="clientName"><i class="fas fa-user-tie"></i> Nom du locataire</label>
                            <select id="clientName" required>
                                <option value="">Sélectionnez un locataire</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ownerName"><i class="fas fa-user"></i> Nom du propriétaire</label>
                            <input type="text" id="ownerName" value="M. KOLA" required>
                        </div>
                        <div class="form-group">
                            <label for="invoiceNumber"><i class="fas fa-hashtag"></i> Numéro de facture</label>
                            <input type="text" id="invoiceNumber" required readonly>
                            <small style="color: var(--primary-color); font-weight: 500;">Généré automatiquement</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="houseName"><i class="fas fa-home"></i> Nom de la maison</label>
                            <select id="houseName" required>
                                <option value="">Sélectionnez une maison</option>
                                <option value="Villa les Cocotiers">Villa les Cocotiers</option>
                                <option value="Résidence du Lac">Résidence du Lac</option>
                                <option value="Immeuble le Progrès">Immeuble le Progrès</option>
                                <option value="Maison Familiale">Maison Familiale</option>
                                <option value="Appartement Moderne">Appartement Moderne</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="neighborhood"><i class="fas fa-map"></i> Quartier</label>
                            <select id="neighborhood" required>
                                <option value="">Sélectionnez un quartier</option>
                                <option value="Kozah">Kozah</option>
                                <option value="Bafilo">Bafilo</option>
                                <option value="Niamtougou">Niamtougou</option>
                                <option value="Sokodé">Sokodé</option>
                                <option value="Lomé">Lomé</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="propertyAddress"><i class="fas fa-home"></i> Adresse complète du logement</label>
                            <input type="text" id="propertyAddress" readonly required>
                            <small style="color: var(--primary-color); font-weight: 500;">Générée automatiquement</small>
                        </div>
                        <div class="form-group">
                            <label for="tenantContact"><i class="fas fa-phone"></i> Contact du locataire</label>
                            <input type="text" id="tenantContact" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rentMonth"><i class="fas fa-calendar"></i> Mois à payer</label>
                            <input type="month" id="rentMonth" required>
                        </div>
                        <div class="form-group">
                            <label for="dueDate"><i class="fas fa-clock"></i> Date d'échéance</label>
                            <input type="date" id="dueDate" required>
                        </div>
                    </div>
                    
                    <!-- Section de calcul automatique du total -->
                    <div class="auto-total-section">
                        <h3><i class="fas fa-calculator"></i> Calcul Automatique du Total</h3>
                        <div class="auto-total-row">
                            <span class="auto-total-label">Total des charges:</span>
                            <span class="auto-total-value" id="autoTotalCharges">0 FCFA</span>
                        </div>
                        <div class="auto-total-row">
                            <span class="auto-total-label">Loyer mensuel:</span>
                            <span class="auto-total-value" id="autoTotalRent">0 FCFA</span>
                        </div>
                        <div class="auto-total-row">
                            <span class="auto-total-label">Total général:</span>
                            <span class="auto-total-value" id="autoTotalGeneral">0 FCFA</span>
                        </div>
                        <div class="auto-total-actions">
                            <button type="button" id="autoCalculate" class="secondary">
                                <i class="fas fa-sync-alt"></i> Calculer automatiquement
                            </button>
                            <button type="button" id="applyAutoTotal" class="whatsapp">
                                <i class="fas fa-check"></i> Appliquer le total
                            </button>
                        </div>
                    </div>
                    
                    <h3><i class="fas fa-money-bill-wave"></i> Détails du Loyer</h3>
                    <div id="itemsContainer">
                        <!-- Les éléments seront ajoutés dynamiquement ici -->
                    </div>
                    
                    <div class="form-row">
                        <button type="button" id="addItem" class="primary"><i class="fas fa-plus"></i> Ajouter une charge</button>
                    </div>
                    
                    <div class="actions">
                        <button type="button" id="generateInvoice" class="primary"><i class="fas fa-file-invoice"></i> Générer la facture</button>
                        <button type="button" id="resetInvoice" class="reset"><i class="fas fa-redo"></i> Nouvelle facture</button>
                    </div>
                </form>
            </div>
            
            <div class="invoice-preview" id="invoicePreview" style="display: none;">
                <h2><i class="fas fa-eye"></i> Aperçu de la Facture de Loyer</h2>
                <div class="invoice-container" id="invoiceContainer">
                    <div class="invoice-header">
                        <div class="company-info">
                            <h3 id="previewCompanyName"></h3>
                            <p id="previewCompanyAddress"></p>
                        </div>
                        <div class="invoice-title">
                            <h1>QUITTANCE DE LOYER</h1>
                            <p id="previewInvoiceNumber"></p>
                            <div class="invoice-code" id="previewInvoiceCode"></div>
                        </div>
                        <div class="invoice-details">
                            <p>Date: <span id="previewDate"></span></p>
                            <p>Mois: <span id="previewRentMonth"></span></p>
                            <p>Échéance: <span id="previewDueDate"></span></p>
                        </div>
                    </div>
                    
                    <div class="client-info">
                        <h4>Locataire:</h4>
                        <p id="previewClientName"></p>
                        <p>Contact: <span id="previewTenantContact"></span></p>
                        <p>Logement: <span id="previewPropertyAddress"></span></p>
                    </div>
                    
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Type de charge</th>
                                <th>Description</th>
                                <th>Quantité</th>
                                <th>Prix unitaire (FCFA)</th>
                                <th>Total (FCFA)</th>
                            </tr>
                        </thead>
                        <tbody id="previewItems">
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">Total:</td>
                                <td id="previewTotal">0 FCFA</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="text-align: center;">
                                    <strong>Arrêtée la présente quittance à la somme de :</strong>
                                    <div id="previewTotalLetters" style="margin-top: 10px; font-style: italic;"></div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="invoice-footer">
                        <div class="signature-section">
                            <p>Le locataire</p>
                            <p id="previewClientNameFooter"></p>
                            <div class="signature-line">Signature</div>
                        </div>
                        <div class="signature-section">
                            <p>Le propriétaire</p>
                            <p id="previewOwnerName"></p>
                            <div class="signature-line">Signature</div>
                        </div>
                    </div>
                    
                    <div class="security-section">
                        <p><strong>Code de vérification de la quittance :</strong></p>
                        <div class="payment-code" id="paymentCode"></div>
                        <div id="qrcode"></div>
                        <p><small>Scannez ce QR Code pour vérifier l'authenticité de cette quittance</small></p>
                    </div>
                </div>
                
                <div class="pdf-format-selector">
                    <label>
                        <input type="radio" name="pdfFormat" value="A4" checked> Format A4
                    </label>
                    <label>
                        <input type="radio" name="pdfFormat" value="A5"> Format A5
                    </label>
                </div>
                
                <div class="actions no-print">
                    <button type="button" id="saveInvoice" class="primary"><i class="fas fa-save"></i> Sauvegarder la facture</button>
                    <button type="button" id="downloadPDF" class="secondary"><i class="fas fa-file-pdf"></i> Télécharger en PDF</button>
                    <button type="button" id="printInvoice" class="secondary"><i class="fas fa-print"></i> Imprimer la quittance</button>
                    <button type="button" id="sendWhatsApp" class="whatsapp"><i class="fab fa-whatsapp"></i> Envoyer par WhatsApp</button>
                    <button type="button" id="exportInvoice" class="export"><i class="fas fa-file-export"></i> Exporter en JSON</button>
                    <button type="button" id="resetFromPreview" class="reset"><i class="fas fa-redo"></i> Nouvelle quittance</button>
                </div>
            </div>
        </div>
        
        <!-- Onglet Gestion des locataires -->
        <div id="tenants-tab" class="tab-content">
            <div class="tenants-section">
                <h2><i class="fas fa-users"></i> Gestion des Locataires</h2>
                <div class="form-section">
                    <h3><i class="fas fa-user-plus"></i> Ajouter un locataire</h3>
                    <form id="tenantForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTenantName"><i class="fas fa-user"></i> Nom complet</label>
                                <input type="text" id="newTenantName" required>
                            </div>
                            <div class="form-group">
                                <label for="newTenantContact"><i class="fas fa-phone"></i> Contact</label>
                                <input type="text" id="newTenantContact" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTenantHouse"><i class="fas fa-home"></i> Maison</label>
                                <select id="newTenantHouse" required>
                                    <option value="">Sélectionnez une maison</option>
                                    <option value="Villa les Cocotiers">Villa les Cocotiers</option>
                                    <option value="Résidence du Lac">Résidence du Lac</option>
                                    <option value="Immeuble le Progrès">Immeuble le Progrès</option>
                                    <option value="Maison Familiale">Maison Familiale</option>
                                    <option value="Appartement Moderne">Appartement Moderne</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newTenantNeighborhood"><i class="fas fa-map"></i> Quartier</label>
                                <select id="newTenantNeighborhood" required>
                                    <option value="">Sélectionnez un quartier</option>
                                    <option value="Kozah">Kozah</option>
                                    <option value="Bafilo">Bafilo</option>
                                    <option value="Niamtougou">Niamtougou</option>
                                    <option value="Sokodé">Sokodé</option>
                                    <option value="Lomé">Lomé</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTenantMonthlyRent"><i class="fas fa-money-bill-wave"></i> Loyer mensuel (FCFA)</label>
                                <input type="number" id="newTenantMonthlyRent" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="actions">
                            <button type="submit" id="addTenant" class="primary"><i class="fas fa-plus"></i> Ajouter le locataire</button>
                        </div>
                    </form>
                </div>
                
                <div class="tenants-container" id="tenantsContainer">
                    <!-- Contenu dynamique -->
                </div>
            </div>
        </div>
        
        <!-- Onglet Historique -->
        <div id="history-tab" class="tab-content">
            <div class="history-section">
                <h2><i class="fas fa-history"></i> Historique des Quittances</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterMonth"><i class="fas fa-filter"></i> Filtrer par mois</label>
                        <input type="month" id="filterMonth">
                    </div>
                    <div class="form-group">
                        <label for="filterTenant"><i class="fas fa-user"></i> Filtrer par locataire</label>
                        <select id="filterTenant">
                            <option value="">Tous les locataires</option>
                        </select>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" id="clearFilters" class="secondary"><i class="fas fa-times"></i> Effacer les filtres</button>
                </div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Numéro</th>
                            <th>Locataire</th>
                            <th>Mois</th>
                            <th>Montant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Contenu dynamique -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Onglet Analyse -->
        <div id="sales-tab" class="tab-content">
            <div class="sales-analysis-section">
                <h2><i class="fas fa-chart-bar"></i> Analyse des Revenus</h2>
                
                <!-- Statistiques résumées -->
                <div class="form-section">
                    <h3><i class="fas fa-chart-line"></i> Statistiques Globales</h3>
                    <div class="stats-container">
                        <div class="stat-card">
                            <h4><i class="fas fa-money-bill-wave"></i> Revenu Total</h4>
                            <p id="totalRevenue">0 FCFA</p>
                        </div>
                        <div class="stat-card">
                            <h4><i class="fas fa-receipt"></i> Quittances Générées</h4>
                            <p id="totalInvoices">0</p>
                        </div>
                        <div class="stat-card">
                            <h4><i class="fas fa-users"></i> Locataires Actifs</h4>
                            <p id="activeTenants">0</p>
                        </div>
                        <div class="stat-card">
                            <h4><i class="fas fa-home"></i> Maisons Louées</h4>
                            <p id="rentedHouses">0</p>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="form-section">
                    <h3><i class="fas fa-chart-bar"></i> Évolution des Revenus</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="chartPeriod"><i class="fas fa-calendar"></i> Période d'analyse</label>
                        <select id="chartPeriod">
                            <option value="6">6 derniers mois</option>
                            <option value="12" selected>12 derniers mois</option>
                            <option value="24">24 derniers mois</option>
                            <option value="all">Toute la période</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chartType"><i class="fas fa-chart-line"></i> Type de graphique</label>
                        <select id="chartType">
                            <option value="line">Courbe</option>
                            <option value="bar" selected>Barres</option>
                        </select>
                    </div>
                </div>

                <!-- Analyse par maison -->
                <div class="form-section">
                    <h3><i class="fas fa-home"></i> Performance par Maison</h3>
                    <div class="chart-container">
                        <canvas id="houseChart"></canvas>
                    </div>
                </div>

                <!-- Analyse par locataire -->
                <div class="form-section">
                    <h3><i class="fas fa-user"></i> Top Locataires</h3>
                    <div class="chart-container">
                        <canvas id="tenantChart"></canvas>
                    </div>
                </div>

                <!-- Rapport détaillé -->
                <div class="form-section">
                    <h3><i class="fas fa-file-alt"></i> Rapport Détaillé</h3>
                    <div class="actions">
                        <button type="button" id="generateReport" class="primary">
                            <i class="fas fa-file-pdf"></i> Générer le rapport PDF
                        </button>
                        <button type="button" id="exportData" class="export">
                            <i class="fas fa-file-excel"></i> Exporter les données
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Onglet Vérification -->
        <div id="verify-tab" class="tab-content">
            <div class="verify-section">
                <h2><i class="fas fa-qrcode"></i> Vérification de Quittance</h2>
                <p>Scannez le QR Code d'une quittance pour vérifier son authenticité</p>
                
                <div class="qr-scanner">
                    <p><i class="fas fa-camera fa-3x"></i></p>
                    <p>Zone de scan QR Code</p>
                    <small>Utilisez votre appareil photo pour scanner le QR Code</small>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-search"></i> Vérification Manuelle</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="verifyCode"><i class="fas fa-key"></i> Code de vérification</label>
                            <input type="text" id="verifyCode" placeholder="Entrez le code de vérification">
                        </div>
                    </div>
                    <div class="actions">
                        <button type="button" id="manualVerify" class="primary">
                            <i class="fas fa-check-circle"></i> Vérifier manuellement
                        </button>
                    </div>
                </div>
                
                <div id="verifyResult" class="verify-result">
                    <i class="fas fa-check-circle"></i>
                    <span id="verifyMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let tenants = JSON.parse(localStorage.getItem('tenants')) || [];
        let nextInvoiceNumber = parseInt(localStorage.getItem('nextInvoiceNumber')) || 1;
        let autoSaveInterval;
        let charts = {};

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Gestion de la connexion
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
            
            // Gestion des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', switchTab);
            });
            
            // Initialisation des formulaires
            initializeInvoiceForm();
            initializeTenantsTab();
            initializeHistoryTab();
            initializeAnalysisTab();
            initializeVerifyTab();
            
            // Configuration de la sauvegarde automatique
            setupAutoSave();
            
            // Génération du numéro de facture initial
            generateInvoiceNumber();
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Vérification simple des identifiants
            if (username === 'admin' && password === 'admin123') {
                currentUser = { username: username };
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Charger les données
                loadAppData();
            } else {
                document.getElementById('errorMessage').style.display = 'flex';
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        function switchTab(e) {
            const tabId = e.currentTarget.getAttribute('data-tab');
            
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            e.currentTarget.classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Recharger les données si nécessaire
            if (tabId === 'history') {
                refreshHistoryTable();
            } else if (tabId === 'sales') {
                refreshAnalysisCharts();
            }
        }

        function initializeInvoiceForm() {
            // Initialisation de la date
            document.getElementById('date').valueAsDate = new Date();
            
            // Génération du numéro de facture
            generateInvoiceNumber();
            
            // Mise à jour de l'adresse en fonction de la maison et du quartier
            document.getElementById('houseName').addEventListener('change', updatePropertyAddress);
            document.getElementById('neighborhood').addEventListener('change', updatePropertyAddress);
            
            // Calcul automatique
            document.getElementById('autoCalculate').addEventListener('click', calculateAutoTotal);
            document.getElementById('applyAutoTotal').addEventListener('click', applyAutoTotal);
            
            // Gestion des éléments de facture
            document.getElementById('addItem').addEventListener('click', addInvoiceItem);
            
            // Génération de facture
            document.getElementById('generateInvoice').addEventListener('click', generateInvoicePreview);
            document.getElementById('resetInvoice').addEventListener('click', resetInvoiceForm);
            
            // Actions de l'aperçu
            document.getElementById('saveInvoice').addEventListener('click', saveInvoice);
            document.getElementById('downloadPDF').addEventListener('click', downloadPDF);
            document.getElementById('printInvoice').addEventListener('click', printInvoice);
            document.getElementById('sendWhatsApp').addEventListener('click', sendWhatsApp);
            document.getElementById('exportInvoice').addEventListener('click', exportInvoice);
            document.getElementById('resetFromPreview').addEventListener('click', resetInvoiceForm);
            
            // Chargement des locataires
            refreshTenantSelect();
        }

        function updatePropertyAddress() {
            const house = document.getElementById('houseName').value;
            const neighborhood = document.getElementById('neighborhood').value;
            
            if (house && neighborhood) {
                document.getElementById('propertyAddress').value = `${house}, ${neighborhood}`;
            }
        }

        function generateInvoiceNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const number = nextInvoiceNumber.toString().padStart(4, '0');
            document.getElementById('invoiceNumber').value = `INV-${year}-${number}`;
        }

        function addInvoiceItem() {
            const itemsContainer = document.getElementById('itemsContainer');
            const itemIndex = itemsContainer.children.length;
            
            const itemHTML = `
                <div class="item-row">
                    <button type="button" class="remove-item" onclick="removeInvoiceItem(this)">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type de charge</label>
                            <select name="itemType" required>
                                <option value="">Sélectionnez un type</option>
                                <option value="Loyer">Loyer principal</option>
                                <option value="Eau">Charge d'eau</option>
                                <option value="Électricité">Charge d'électricité</option>
                                <option value="Entretien">Frais d'entretien</option>
                                <option value="Taxe">Taxe municipale</option>
                                <option value="Autre">Autre charge</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" name="itemDescription" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantité</label>
                            <input type="number" name="itemQuantity" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Prix unitaire (FCFA)</label>
                            <input type="number" name="itemPrice" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Total (FCFA)</label>
                            <input type="text" name="itemTotal" readonly>
                        </div>
                    </div>
                </div>
            `;
            
            itemsContainer.insertAdjacentHTML('beforeend', itemHTML);
            
            // Ajouter les écouteurs d'événements pour le calcul automatique
            const newItem = itemsContainer.lastElementChild;
            newItem.querySelector('input[name="itemQuantity"]').addEventListener('input', calculateItemTotal);
            newItem.querySelector('input[name="itemPrice"]').addEventListener('input', calculateItemTotal);
        }

        function removeInvoiceItem(button) {
            button.closest('.item-row').remove();
            calculateAutoTotal();
        }

        function calculateItemTotal(e) {
            const itemRow = e.target.closest('.item-row');
            const quantity = parseFloat(itemRow.querySelector('input[name="itemQuantity"]').value) || 0;
            const price = parseFloat(itemRow.querySelector('input[name="itemPrice"]').value) || 0;
            const total = quantity * price;
            
            itemRow.querySelector('input[name="itemTotal"]').value = total.toLocaleString('fr-FR') + ' FCFA';
            calculateAutoTotal();
        }

        function calculateAutoTotal() {
            let totalCharges = 0;
            let monthlyRent = 0;
            
            // Calculer le total des charges
            document.querySelectorAll('.item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name="itemQuantity"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="itemPrice"]').value) || 0;
                totalCharges += quantity * price;
            });
            
            // Trouver le loyer mensuel (premier élément de type "Loyer")
            const rentItems = document.querySelectorAll('select[name="itemType"]');
            rentItems.forEach(select => {
                if (select.value === "Loyer") {
                    const rentRow = select.closest('.item-row');
                    const quantity = parseFloat(rentRow.querySelector('input[name="itemQuantity"]').value) || 0;
                    const price = parseFloat(rentRow.querySelector('input[name="itemPrice"]').value) || 0;
                    monthlyRent = quantity * price;
                }
            });
            
            const totalGeneral = totalCharges;
            
            // Mettre à jour l'affichage
            document.getElementById('autoTotalCharges').textContent = totalCharges.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('autoTotalRent').textContent = monthlyRent.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('autoTotalGeneral').textContent = totalGeneral.toLocaleString('fr-FR') + ' FCFA';
        }

        function applyAutoTotal() {
            calculateAutoTotal();
            alert('Totaux automatiques appliqués avec succès!');
        }

        function generateInvoicePreview() {
            // Récupérer les données du formulaire
            const formData = {
                date: document.getElementById('date').value,
                companyName: document.getElementById('companyName').value,
                companyAddress: document.getElementById('companyAddress').value,
                clientName: document.getElementById('clientName').value,
                ownerName: document.getElementById('ownerName').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                houseName: document.getElementById('houseName').value,
                neighborhood: document.getElementById('neighborhood').value,
                propertyAddress: document.getElementById('propertyAddress').value,
                tenantContact: document.getElementById('tenantContact').value,
                rentMonth: document.getElementById('rentMonth').value,
                dueDate: document.getElementById('dueDate').value
            };
            
            // Valider le formulaire
            if (!validateInvoiceForm(formData)) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Calculer le total
            let total = 0;
            const items = [];
            
            document.querySelectorAll('.item-row').forEach(row => {
                const type = row.querySelector('select[name="itemType"]').value;
                const description = row.querySelector('input[name="itemDescription"]').value;
                const quantity = parseFloat(row.querySelector('input[name="itemQuantity"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="itemPrice"]').value) || 0;
                const itemTotal = quantity * price;
                
                items.push({ type, description, quantity, price, total: itemTotal });
                total += itemTotal;
            });
            
            if (items.length === 0) {
                alert('Veuillez ajouter au moins un élément de facture');
                return;
            }
            
            // Mettre à jour l'aperçu
            updateInvoicePreview(formData, items, total);
            
            // Afficher l'aperçu
            document.getElementById('invoicePreview').style.display = 'block';
            
            // Générer le code de vérification et QR Code
            generateSecurityCode(formData.invoiceNumber);
        }

        function updateInvoicePreview(formData, items, total) {
            // Mettre à jour les informations de base
            document.getElementById('previewCompanyName').textContent = formData.companyName;
            document.getElementById('previewCompanyAddress').textContent = formData.companyAddress;
            document.getElementById('previewClientName').textContent = formData.clientName;
            document.getElementById('previewClientNameFooter').textContent = formData.clientName;
            document.getElementById('previewOwnerName').textContent = formData.ownerName;
            document.getElementById('previewInvoiceNumber').textContent = `N° ${formData.invoiceNumber}`;
            document.getElementById('previewDate').textContent = new Date(formData.date).toLocaleDateString('fr-FR');
            
            // Formater correctement le mois
            const rentMonth = new Date(formData.rentMonth + '-01');
            document.getElementById('previewRentMonth').textContent = rentMonth.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
            
            document.getElementById('previewDueDate').textContent = new Date(formData.dueDate).toLocaleDateString('fr-FR');
            document.getElementById('previewTenantContact').textContent = formData.tenantContact;
            document.getElementById('previewPropertyAddress').textContent = formData.propertyAddress;
            document.getElementById('previewTotal').textContent = total.toLocaleString('fr-FR') + ' FCFA';
            
            // Mettre à jour les éléments
            const itemsContainer = document.getElementById('previewItems');
            itemsContainer.innerHTML = '';
            
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.type}</td>
                    <td>${item.description}</td>
                    <td>${item.quantity}</td>
                    <td>${item.price.toLocaleString('fr-FR')} FCFA</td>
                    <td>${item.total.toLocaleString('fr-FR')} FCFA</td>
                `;
                itemsContainer.appendChild(row);
            });
            
            // Mettre à jour le total en lettres
            document.getElementById('previewTotalLetters').textContent = numberToWords(total);
        }

        function generateSecurityCode(invoiceNumber) {
            // Générer un code de vérification unique
            const code = `QL-${invoiceNumber}-${Date.now().toString(36).toUpperCase()}`;
            document.getElementById('paymentCode').textContent = code;
            
            // Générer le QR Code
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            const qrData = JSON.stringify({
                code: code,
                invoiceNumber: invoiceNumber,
                timestamp: new Date().toISOString()
            });
            
            new QRCode(qrcodeContainer, {
                text: qrData,
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            return code;
        }

        function validateInvoiceForm(formData) {
            return Object.values(formData).every(value => value && value.trim() !== '');
        }

        // Fonction améliorée pour convertir les nombres en lettres
        function numberToWords(number) {
            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante', 'quatre-vingt', 'quatre-vingt'];
            
            if (number === 0) return 'zéro';
            
            let words = '';
            
            // Convertir en entier
            const integerPart = Math.floor(number);
            
            if (integerPart >= 1000000) {
                const millions = Math.floor(integerPart / 1000000);
                words += convertNumber(millions) + ' million' + (millions > 1 ? 's' : '') + ' ';
                number = integerPart % 1000000;
            }
            
            if (integerPart >= 1000) {
                const thousands = Math.floor(integerPart / 1000);
                if (thousands === 1) {
                    words += 'mille ';
                } else {
                    words += convertNumber(thousands) + ' mille ';
                }
                number = integerPart % 1000;
            }
            
            words += convertNumber(integerPart % 1000);
            
            // Ajouter "francs CFA"
            words = words.trim() + ' francs CFA';
            
            return words.charAt(0).toUpperCase() + words.slice(1);
            
            function convertNumber(num) {
                if (num === 0) return '';
                if (num < 10) return units[num];
                if (num < 20) return teens[num - 10];
                if (num < 100) {
                    const ten = Math.floor(num / 10);
                    const unit = num % 10;
                    if (ten === 7 || ten === 9) {
                        return tens[ten] + '-' + teens[unit];
                    }
                    return tens[ten] + (unit > 0 ? '-' + units[unit] : '');
                }
                if (num < 1000) {
                    const hundred = Math.floor(num / 100);
                    const remainder = num % 100;
                    return (hundred === 1 ? 'cent' : units[hundred] + ' cent') + 
                           (remainder > 0 ? ' ' + convertNumber(remainder) : '');
                }
                return '';
            }
        }

        function resetInvoiceForm() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('itemsContainer').innerHTML = '';
            document.getElementById('invoicePreview').style.display = 'none';
            document.getElementById('date').valueAsDate = new Date();
            generateInvoiceNumber();
            calculateAutoTotal();
        }

        function saveInvoice() {
            const invoiceData = collectInvoiceData();
            invoices.push(invoiceData);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Incrémenter le numéro de facture
            nextInvoiceNumber++;
            localStorage.setItem('nextInvoiceNumber', nextInvoiceNumber.toString());
            
            alert('Quittance sauvegardée avec succès!');
            refreshHistoryTable();
            refreshAnalysisCharts();
        }

        function collectInvoiceData() {
            const formData = {
                date: document.getElementById('date').value,
                companyName: document.getElementById('companyName').value,
                companyAddress: document.getElementById('companyAddress').value,
                clientName: document.getElementById('clientName').value,
                ownerName: document.getElementById('ownerName').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                houseName: document.getElementById('houseName').value,
                neighborhood: document.getElementById('neighborhood').value,
                propertyAddress: document.getElementById('propertyAddress').value,
                tenantContact: document.getElementById('tenantContact').value,
                rentMonth: document.getElementById('rentMonth').value,
                dueDate: document.getElementById('dueDate').value,
                securityCode: document.getElementById('paymentCode').textContent,
                timestamp: new Date().toISOString()
            };
            
            let total = 0;
            const items = [];
            
            document.querySelectorAll('.item-row').forEach(row => {
                const type = row.querySelector('select[name="itemType"]').value;
                const description = row.querySelector('input[name="itemDescription"]').value;
                const quantity = parseFloat(row.querySelector('input[name="itemQuantity"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="itemPrice"]').value) || 0;
                const itemTotal = quantity * price;
                
                items.push({ type, description, quantity, price, total: itemTotal });
                total += itemTotal;
            });
            
            return { ...formData, items, total, id: Date.now().toString() };
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const invoiceElement = document.getElementById('invoiceContainer');
            
            html2canvas(invoiceElement).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save(`${document.getElementById('invoiceNumber').value}.pdf`);
            });
        }

        function printInvoice() {
            window.print();
        }

        function sendWhatsApp() {
            const clientName = document.getElementById('clientName').value;
            const total = document.getElementById('previewTotal').textContent;
            const message = `Bonjour ${clientName}, votre quittance de loyer est prête. Montant: ${total}. Code de vérification: ${document.getElementById('paymentCode').textContent}`;
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        function exportInvoice() {
            const invoiceData = collectInvoiceData();
            const dataStr = JSON.stringify(invoiceData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${invoiceData.invoiceNumber}.json`;
            link.click();
        }

        // Gestion des locataires
        function initializeTenantsTab() {
            document.getElementById('tenantForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewTenant();
            });
            refreshTenantsDisplay();
        }

        function addNewTenant() {
            const tenant = {
                id: Date.now().toString(),
                name: document.getElementById('newTenantName').value,
                contact: document.getElementById('newTenantContact').value,
                house: document.getElementById('newTenantHouse').value,
                neighborhood: document.getElementById('newTenantNeighborhood').value,
                monthlyRent: parseFloat(document.getElementById('newTenantMonthlyRent').value),
                joinDate: new Date().toISOString()
            };
            
            tenants.push(tenant);
            localStorage.setItem('tenants', JSON.stringify(tenants));
            
            document.getElementById('tenantForm').reset();
            refreshTenantsDisplay();
            refreshTenantSelect();
            
            alert('Locataire ajouté avec succès!');
        }

        function refreshTenantsDisplay() {
            const container = document.getElementById('tenantsContainer');
            container.innerHTML = '';
            
            if (tenants.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-text);">Aucun locataire enregistré</p>';
                return;
            }
            
            tenants.forEach(tenant => {
                const card = document.createElement('div');
                card.className = 'tenant-card';
                card.innerHTML = `
                    <h3>${tenant.name}</h3>
                    <p><i class="fas fa-phone"></i> ${tenant.contact}</p>
                    <p><i class="fas fa-home"></i> ${tenant.house}</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${tenant.neighborhood}</p>
                    <p><i class="fas fa-money-bill-wave"></i> ${tenant.monthlyRent.toLocaleString('fr-FR')} FCFA/mois</p>
                    <div class="tenant-actions">
                        <button class="primary" onclick="editTenant('${tenant.id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="secondary" onclick="createInvoiceForTenant('${tenant.id}')">
                            <i class="fas fa-file-invoice"></i> Créer quittance
                        </button>
                        <button class="reset" onclick="deleteTenant('${tenant.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function refreshTenantSelect() {
            const select = document.getElementById('clientName');
            const filterSelect = document.getElementById('filterTenant');
            
            // Conserver la sélection actuelle
            const currentValue = select.value;
            const filterCurrentValue = filterSelect.value;
            
            // Vider les options (en gardant la première)
            while (select.children.length > 1) select.removeChild(select.lastChild);
            while (filterSelect.children.length > 1) filterSelect.removeChild(filterSelect.lastChild);
            
            // Ajouter les locataires
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.name;
                option.textContent = tenant.name;
                select.appendChild(option);
                
                const filterOption = document.createElement('option');
                filterOption.value = tenant.name;
                filterOption.textContent = tenant.name;
                filterSelect.appendChild(filterOption);
            });
            
            // Restaurer les sélections
            if (currentValue) select.value = currentValue;
            if (filterCurrentValue) filterSelect.value = filterCurrentValue;
        }

        function createInvoiceForTenant(tenantId) {
            const tenant = tenants.find(t => t.id === tenantId);
            if (tenant) {
                // Remplir automatiquement le formulaire de facture
                document.getElementById('clientName').value = tenant.name;
                document.getElementById('tenantContact').value = tenant.contact;
                document.getElementById('houseName').value = tenant.house;
                document.getElementById('neighborhood').value = tenant.neighborhood;
                updatePropertyAddress();
                
                // Basculer vers l'onglet de création
                document.querySelector('.tab[data-tab="create"]').click();
                
                // Ajouter automatiquement le loyer comme premier élément
                if (document.querySelectorAll('.item-row').length === 0) {
                    addInvoiceItem();
                    const firstItem = document.querySelector('.item-row');
                    firstItem.querySelector('select[name="itemType"]').value = 'Loyer';
                    firstItem.querySelector('input[name="itemDescription"]').value = 'Loyer mensuel';
                    firstItem.querySelector('input[name="itemPrice"]').value = tenant.monthlyRent;
                    calculateItemTotal({ target: firstItem.querySelector('input[name="itemPrice"]') });
                }
            }
        }

        // Gestion de l'historique
        function initializeHistoryTab() {
            document.getElementById('filterMonth').addEventListener('change', refreshHistoryTable);
            document.getElementById('filterTenant').addEventListener('change', refreshHistoryTable);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            refreshHistoryTable();
        }

        function refreshHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const filterMonth = document.getElementById('filterMonth').value;
            const filterTenant = document.getElementById('filterTenant').value;
            
            tbody.innerHTML = '';
            
            const filteredInvoices = invoices.filter(invoice => {
                let matches = true;
                if (filterMonth) {
                    matches = matches && invoice.rentMonth.startsWith(filterMonth);
                }
                if (filterTenant) {
                    matches = matches && invoice.clientName === filterTenant;
                }
                return matches;
            });
            
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--light-text);">Aucune quittance trouvée</td></tr>';
                return;
            }
            
            filteredInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(invoice.date).toLocaleDateString('fr-FR')}</td>
                    <td>${invoice.invoiceNumber}</td>
                    <td>${invoice.clientName}</td>
                    <td>${new Date(invoice.rentMonth + '-01').toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' })}</td>
                    <td>${invoice.total.toLocaleString('fr-FR')} FCFA</td>
                    <td>
                        <button class="primary" onclick="viewInvoice('${invoice.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="secondary" onclick="downloadInvoice('${invoice.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="reset" onclick="deleteInvoice('${invoice.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearFilters() {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterTenant').value = '';
            refreshHistoryTable();
        }

        // Analyse des données
        function initializeAnalysisTab() {
            document.getElementById('chartPeriod').addEventListener('change', refreshAnalysisCharts);
            document.getElementById('chartType').addEventListener('change', refreshAnalysisCharts);
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('exportData').addEventListener('click', exportAnalysisData);
        }

        function refreshAnalysisCharts() {
            updateStats();
            createRevenueChart();
            createHouseChart();
            createTenantChart();
        }

        function updateStats() {
            const totalRevenue = invoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const totalInvoices = invoices.length;
            const activeTenants = tenants.length;
            const rentedHouses = [...new Set(tenants.map(tenant => tenant.house))].length;
            
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('totalInvoices').textContent = totalInvoices;
            document.getElementById('activeTenants').textContent = activeTenants;
            document.getElementById('rentedHouses').textContent = rentedHouses;
        }

        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (charts.revenue) {
                charts.revenue.destroy();
            }
            
            const period = parseInt(document.getElementById('chartPeriod').value);
            const chartType = document.getElementById('chartType').value;
            
            // Générer les données basées sur les factures réelles
            const monthlyData = getMonthlyRevenueData(period);
            
            charts.revenue = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Revenus mensuels (FCFA)',
                        data: monthlyData.data,
                        backgroundColor: chartType === 'bar' ? 'rgba(76, 175, 80, 0.6)' : 'rgba(76, 175, 80, 0.2)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 2,
                        fill: chartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('fr-FR') + ' FCFA';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getMonthlyRevenueData(period) {
            const months = [];
            const revenue = [];
            
            const now = new Date();
            const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = date.toISOString().substring(0, 7);
                
                const monthRevenue = invoices
                    .filter(inv => inv.rentMonth === monthKey)
                    .reduce((sum, inv) => sum + inv.total, 0);
                
                months.push(`${monthNames[date.getMonth()]} ${date.getFullYear()}`);
                revenue.push(monthRevenue);
            }
            
            return { labels: months, data: revenue };
        }

        function createHouseChart() {
            const ctx = document.getElementById('houseChart');
            if (charts.house) {
                charts.house.destroy();
            }
            
            // Regrouper par maison
            const houseRevenue = {};
            invoices.forEach(invoice => {
                if (!houseRevenue[invoice.house]) {
                    houseRevenue[invoice.house] = 0;
                }
                houseRevenue[invoice.house] += invoice.total;
            });
            
            const houses = Object.keys(houseRevenue);
            const revenues = Object.values(houseRevenue);
            
            if (houses.length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align: center; color: var(--light-text);">Aucune donnée disponible</p>';
                return;
            }
            
            charts.house = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: houses,
                    datasets: [{
                        data: revenues,
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(244, 67, 54, 0.8)',
                            'rgba(0, 188, 212, 0.8)',
                            'rgba(233, 30, 99, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTenantChart() {
            const ctx = document.getElementById('tenantChart');
            if (charts.tenant) {
                charts.tenant.destroy();
            }
            
            // Regrouper par locataire
            const tenantRevenue = {};
            invoices.forEach(invoice => {
                if (!tenantRevenue[invoice.clientName]) {
                    tenantRevenue[invoice.clientName] = 0;
                }
                tenantRevenue[invoice.clientName] += invoice.total;
            });
            
            // Trier et prendre le top 5
            const topTenants = Object.entries(tenantRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (topTenants.length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align: center; color: var(--light-text);">Aucune donnée disponible</p>';
                return;
            }
            
            charts.tenant = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topTenants.map(t => t[0]),
                    datasets: [{
                        label: 'Revenus par locataire (FCFA)',
                        data: topTenants.map(t => t[1]),
                        backgroundColor: 'rgba(76, 175, 80, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('fr-FR') + ' FCFA';
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateReport() {
            alert('Génération du rapport PDF...');
            // Implémentation complète avec jsPDF
        }

        function exportAnalysisData() {
            const analysisData = {
                stats: {
                    totalRevenue: invoices.reduce((sum, invoice) => sum + invoice.total, 0),
                    totalInvoices: invoices.length,
                    activeTenants: tenants.length,
                    rentedHouses: [...new Set(tenants.map(tenant => tenant.house))].length
                },
                invoices: invoices,
                tenants: tenants,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(analysisData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `analyse-loyers-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Vérification des quittances
        function initializeVerifyTab() {
            document.getElementById('manualVerify').addEventListener('click', manualVerify);
        }

        function manualVerify() {
            const code = document.getElementById('verifyCode').value.trim();
            if (!code) {
                alert('Veuillez entrer un code de vérification');
                return;
            }
            
            const result = verifyInvoiceCode(code);
            
            const resultDiv = document.getElementById('verifyResult');
            const message = document.getElementById('verifyMessage');
            
            if (result.valid) {
                resultDiv.className = 'verify-result valid';
                resultDiv.querySelector('i').className = 'fas fa-check-circle';
                message.textContent = `✅ Quittance valide - ${result.invoice.clientName} - ${new Date(result.invoice.date).toLocaleDateString('fr-FR')} - ${result.invoice.total.toLocaleString('fr-FR')} FCFA`;
            } else {
                resultDiv.className = 'verify-result invalid';
                resultDiv.querySelector('i').className = 'fas fa-times-circle';
                message.textContent = '❌ Code de quittance invalide ou introuvable';
            }
            
            resultDiv.style.display = 'block';
        }

        function verifyInvoiceCode(code) {
            const invoice = invoices.find(inv => inv.securityCode === code);
            return {
                valid: !!invoice,
                invoice: invoice
            };
        }

        // Fonctions utilitaires
        function setupAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (currentUser) {
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    localStorage.setItem('tenants', JSON.stringify(tenants));
                    localStorage.setItem('nextInvoiceNumber', nextInvoiceNumber.toString());
                    console.log('Sauvegarde automatique effectuée');
                }
            }, 30000);
        }

        function loadAppData() {
            invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            tenants = JSON.parse(localStorage.getItem('tenants')) || [];
            nextInvoiceNumber = parseInt(localStorage.getItem('nextInvoiceNumber')) || 1;
            
            refreshTenantsDisplay();
            refreshTenantSelect();
            refreshHistoryTable();
        }

        // Nettoyage à la fermeture
        window.addEventListener('beforeunload', () => {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
        });

        // Fonctions manquantes pour la démonstration
        function editTenant(tenantId) {
            const tenant = tenants.find(t => t.id === tenantId);
            if (tenant) {
                document.getElementById('newTenantName').value = tenant.name;
                document.getElementById('newTenantContact').value = tenant.contact;
                document.getElementById('newTenantHouse').value = tenant.house;
                document.getElementById('newTenantNeighborhood').value = tenant.neighborhood;
                document.getElementById('newTenantMonthlyRent').value = tenant.monthlyRent;
                
                // Supprimer l'ancien locataire
                deleteTenant(tenantId);
                
                alert('Modifiez les informations et cliquez sur "Ajouter le locataire" pour sauvegarder');
            }
        }

        function deleteTenant(tenantId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce locataire ?')) {
                tenants = tenants.filter(t => t.id !== tenantId);
                localStorage.setItem('tenants', JSON.stringify(tenants));
                refreshTenantsDisplay();
                refreshTenantSelect();
                refreshAnalysisCharts();
            }
        }

        function viewInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                // Remplir le formulaire avec les données de la facture
                Object.keys(invoice).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = invoice[key];
                    }
                });
                
                // Mettre à jour l'aperçu
                updateInvoicePreview(invoice, invoice.items, invoice.total);
                document.getElementById('invoicePreview').style.display = 'block';
                
                // Basculer vers l'onglet création
                document.querySelector('.tab[data-tab="create"]').click();
            }
        }

        function downloadInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                const dataStr = JSON.stringify(invoice, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${invoice.invoiceNumber}.json`;
                link.click();
            }
        }

        function deleteInvoice(invoiceId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette quittance ?')) {
                invoices = invoices.filter(inv => inv.id !== invoiceId);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                refreshHistoryTable();
                refreshAnalysisCharts();
            }
        }
    </script>
</body>
</html>
